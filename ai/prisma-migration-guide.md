# Руководство по миграции на Prisma и решению возможных проблем

## Общие инструкции по миграции

### Подготовка базы данных

1. Убедитесь, что у вас установлен PostgreSQL и он запущен
2. Создайте базу данных `dresscutur`:
   ```
   createdb dresscutur
   ```
   или используйте pgAdmin для создания БД

3. Проверьте настройки подключения в файле `.env`:
   ```
   DATABASE_URL="postgresql://postgres:postgres@localhost:5432/dresscutur"
   ```
   Замените `postgres:postgres` на ваш логин и пароль, если они отличаются

### Установка зависимостей

```
npm install ts-node --save-dev
```

### Запуск миграции

```
npx prisma migrate dev --name init
```

Если вы получаете ошибки доступа к PowerShell скриптам, выполните один из следующих вариантов:

1. Запустите CMD (не PowerShell) и выполните команды в нем
2. Или временно измените политику выполнения PowerShell:
   ```
   Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process
   ```
   затем запустите `npx prisma migrate dev --name init`

### Заполнение базы данных начальными данными

```
npx prisma db seed
```

## Решение распространенных проблем

### Проблема: Ошибка "Cannot find module 'ts-node'"

**Решение:**
```
npm install ts-node --save-dev
```

### Проблема: Prisma Client не генерируется

**Решение:**
```
npx prisma generate
```

### Проблема: Ошибка доступа к базе данных

**Решение:**
1. Проверьте, запущен ли PostgreSQL
2. Проверьте строку подключения в `.env`
3. Убедитесь, что пользователь PostgreSQL имеет права на создание БД

### Проблема: Ошибка при создании миграции из-за существующих таблиц

**Решение:**
1. Удалите существующую базу данных:
   ```
   dropdb dresscutur
   ```
2. Создайте новую базу:
   ```
   createdb dresscutur
   ```
3. Повторите миграцию:
   ```
   npx prisma migrate dev --name init
   ```

### Проблема: Ошибка в seed-скрипте

**Решение:**
1. Проверьте наличие ошибок в файле `prisma/seed.ts`
2. Исправьте ошибки и запустите снова:
   ```
   npx prisma db seed
   ```

## Проверка успешности миграции

1. Запустите Prisma Studio для визуального просмотра данных:
   ```
   npx prisma studio
   ```

2. Проверьте наличие созданных таблиц и данных

3. Тестовые учетные записи после seed:
   - Администратор: admin@dresscutur.ru / admin123
   - Редактор: editor@dresscutur.ru / editor123

## Дополнительные полезные команды

### Сброс базы данных (удаление всех данных)
```
npx prisma migrate reset
```

### Проверка статуса миграции
```
npx prisma migrate status
```

### Создание дополнительной миграции (после изменения схемы)
```
npx prisma migrate dev --name название_миграции
```

### Применение миграций в production
```
npx prisma migrate deploy
```

### Интроспекция существующей базы данных
```
npx prisma db pull
```

## Структура миграций Prisma

После выполнения миграции в папке `prisma/migrations` будет создана подпапка с временной меткой и названием миграции, например:
```
20240715120000_init/
```

Эта папка содержит SQL-скрипты, которые были выполнены для создания схемы базы данных. Не удаляйте и не изменяйте эти файлы вручную, так как они используются Prisma для отслеживания состояния базы данных.

## Отладка работы с базой данных

Для включения логирования SQL-запросов, выполняемых Prisma, добавьте следующие настройки при создании клиента:

```typescript
const prisma = new PrismaClient({
  log: ['query', 'info', 'warn', 'error'],
});
```

Это поможет отслеживать все запросы к базе данных, что полезно при отладке проблем производительности или неожиданных результатов. 