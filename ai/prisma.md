# План замены тестового контента на реальный

## Статус внедрения по модулям

| Модуль | Адаптирован backend | Адаптирован frontend | Статус |
|--------|---------------------|---------------------|--------|
| Услуги (Services) | ✅ | ✅ | Завершено |
| Ткани (Fabrics) | ✅ | ✅ | Завершено |
| Галерея (Gallery) | ✅ | ✅ | Завершено |
| FAQ | ✅ | ✅ | Завершено |
| Контакты (Contacts) | ✅ | ✅ | Завершено |
| Календарь (Calendar) | ✅ | ✅ | Завершено |
| Настройки (Settings) | ❌ | ❌ | Не начато |
| Отзывы (Testimonials) | ❌ | ❌ | Не начато |
| Цены (Prices) | ❌ | ❌ | Не начато |
| Аутентификация (Auth) | ✅ | ✅ | Завершено | (Упрощенная версия)
| Главная страница | ✅ | ✅ | Завершено |

## План по разделам

### 1. Публичная часть сайта

1. **Главная страница ✅**
   - Заменены статические данные на динамические из БД
   - Обновлены компоненты для работы с prisma actions
   - Добавлено кэширование для быстрой загрузки

2. **Страница услуг ✅**
   - Интегрирована с prisma-actions для получения данных
   - Обновлены компоненты отображения услуг
   - Настроена фильтрация и сортировка по активным услугам

3. **Страница тканей ✅**
   - Заменены моковые данные на реальные
   - Обновлен компонент каталога тканей
   - Добавлена фильтрация

4. **Галерея ✅**
   - Внедрены prisma-actions для загрузки элементов галереи
   - Обновлены компоненты отображения и фильтрации
   - Добавлена оптимизация изображений

5. **FAQ ✅**
   - Заменены статические данные на динамические
   - Обновлены компоненты аккордеона и категорий
   - Настроена сортировка по порядку отображения

6. **Форма контактов ✅**
   - Созданы server actions для сохранения заявок
   - Обновлена обработка формы на клиенте
   - Добавлена валидация и обработка ошибок

### 2. Административная часть

1. **Аутентификация ✅**
   - Завершена интеграция с Prisma
   - Настроена защита route middleware
   - Добавлен учет времени последнего логина

2. **Админка услуг ✅**
   - Все server actions переведены на Prisma
   - Компоненты адаптированы для работы с реальными данными
   - Функционал CRUD полностью работает

3. **Админка тканей ✅**
   - Выполнена миграция всех действий на Prisma
   - Адаптированы формы и компоненты списков
   - Настроена загрузка и управление изображениями

4. **Управление галереей ✅**
   - Завершена интеграция с Prisma
   - Адаптированы компоненты для работы с реальными данными
   - Настроена загрузка и обработка изображений

5. **Управление FAQ ✅**
   - Выполнен переход на реальные данные из БД
   - Обновлены компоненты создания и редактирования
   - Реализован drag-and-drop для изменения порядка

6. **Управление контактами ✅**
   - Созданы новые server actions с Prisma
   - Реализована фильтрация и обработка заявок
   - Добавлен функционал изменения статуса заявок

7. **Календарь и события**
   - Реализовать хранение данных в БД
   - Создать server actions для управления событиями
   - Обновить компоненты календаря

8. **Настройки**
   - Создать таблицу и модель для хранения настроек
   - Реализовать управление настройками через админку
   - Добавить кэширование настроек

9. **Управление ценами**
   - Создать модель и таблицу для хранения прайсов
   - Реализовать server actions для управления ценами
   - Обновить компоненты отображения в админке и на сайте

## Последовательность выполнения

1. Завершить адаптацию тканей, галереи и FAQ (backend уже готов)
2. Реализовать функционал для контактов
3. Внедрить функционал календаря и событий
4. Добавить управление настройками
5. Добавить управление ценами и отзывами
6. Финальная оптимизация и тестирование

# План по замене тестовых данных на реальные с использованием Prisma

## Текущее состояние проекта

- Настроена Prisma с подключением к PostgreSQL
- Создана схема данных с моделями для всех сущностей проекта
- Реализованы server actions для взаимодействия с данными
- В проекте используются заглушки с тестовыми данными (mock data)

## Задачи по миграции на реальные данные

### 1. Проверить работоспособность Prisma и базы данных

- Убедиться, что установлены все необходимые пакеты:
  ```
  npm install @prisma/client
  npm install prisma --save-dev
  npm install ts-node --save-dev
  ```

- Проверить строку подключения к базе данных в файле `.env`
  ```
  DATABASE_URL="postgresql://postgres:postgres@localhost:5432/dresscutur"
  ```

- Подготовить базу данных (создать, если не существует)
  ```
  createdb dresscutur
  ```
  или через pgAdmin создать базу данных с именем dresscutur

- Выполнить миграцию Prisma для создания таблиц:
  ```
  npx prisma migrate dev --name init
  ```

- Создать seed-файл для начального заполнения базы данными:
  ```
  npx prisma db seed
  ```

### 2. Последовательная замена тестовых данных на реальные

#### 2.1 User и Auth

- Реализовать server action для регистрации и аутентификации пользователей
- Создать базовых администраторов через seed-скрипт

#### 2.2 Services

- Заменить `mockServices` в `app/actions/admin/services.ts` на обращение к базе данных:
  ```typescript
  export async function getServices(): Promise<Service[]> {
    return await prisma.service.findMany({
      orderBy: { order: 'asc' },
      where: { isActive: true }
    });
  }
  ```

- Реализовать CRUD-операции для услуг:
  - createService
  - updateService
  - deleteService
  - getServiceById

#### 2.3 Fabrics

- Заменить `mockFabrics` в `app/actions/admin/fabrics.ts` на обращение к базе данных
- Реализовать CRUD-операции для тканей
- Обновить интерфейсы для работы с моделью Prisma

#### 2.4 Gallery

- Заменить `mockGalleryItems` в `app/actions/admin/gallery.ts` на обращение к базе данных
- Реализовать CRUD-операции для элементов галереи
- Обновить связанные компоненты на фронтенде

#### 2.5 FAQ

- Заменить `mockFaqs` в админке на обращение к базе данных
- Реализовать CRUD-операции для FAQ
- Обновить компоненты отображения FAQ на публичной части сайта

#### 2.6 Contacts и ContactRequests

- Заменить `mockContacts` на реальные данные из базы
- Реализовать обработку новых заявок через форму контактов
- Настроить статусы и фильтрацию заявок

#### 2.7 Events и Calendar

- Реализовать server actions для работы с календарем
- Заменить временные данные на запросы к базе данных
- Настроить проверку занятых слотов и бронирование времени

#### 2.8 Settings

- Заменить `mockSettings` на данные из таблицы Settings
- Реализовать механизм кэширования настроек для улучшения производительности

### 3. Оптимизация производительности

- Настроить кэширование запросов с использованием Next.js cache и revalidate
- Добавить индексы в базу данных для часто используемых запросов
- Оптимизировать запросы с помощью агрегации и вложенной выборки Prisma

### 4. Миграция медиа-файлов

- Настроить хранение файлов (локальная файловая система или облачное хранилище)
- Реализовать загрузку изображений через UploadThing или другой сервис
- Связать медиа-файлы с соответствующими записями в базе данных

### 5. Тестирование и исправление ошибок

- Провести тестирование всех CRUD-операций
- Проверить работу фильтрации и сортировки
- Убедиться в корректной работе связей между таблицами
- Исправить возможные ошибки и оптимизировать код

## Пример кода для замены тестовых данных

### Пример для Services

```typescript
'use server';

import { revalidatePath } from 'next/cache';
import { prisma } from '~/app/lib/prisma';
import { z } from 'zod';

// Схема валидации для сервиса
const serviceSchema = z.object({
  title: z.string().min(1, 'Название обязательно'),
  description: z.string().min(1, 'Описание обязательно'),
  icon: z.string().optional().nullable(),
  image: z.string().optional().nullable(),
  isActive: z.boolean().default(true),
  order: z.number().default(0),
});

// Получение всех сервисов
export async function getServices() {
  return await prisma.service.findMany({
    orderBy: { order: 'asc' },
  });
}

// Получение сервиса по ID
export async function getServiceById(id: string) {
  return await prisma.service.findUnique({
    where: { id }
  });
}

// Создание нового сервиса
export async function createService(data: z.infer<typeof serviceSchema>) {
  const result = serviceSchema.safeParse(data);
  
  if (!result.success) {
    return { success: false, errors: result.error.format() };
  }

  await prisma.service.create({
    data: result.data
  });

  revalidatePath('/admin/services');
  revalidatePath('/services');
  
  return { success: true };
}

// Обновление сервиса
export async function updateService(id: string, data: z.infer<typeof serviceSchema>) {
  const result = serviceSchema.safeParse(data);
  
  if (!result.success) {
    return { success: false, errors: result.error.format() };
  }

  await prisma.service.update({
    where: { id },
    data: result.data
  });

  revalidatePath('/admin/services');
  revalidatePath('/services');
  
  return { success: true };
}

// Удаление сервиса
export async function deleteService(id: string) {
  await prisma.service.delete({
    where: { id }
  });

  revalidatePath('/admin/services');
  revalidatePath('/services');
  
  return { success: true };
}
```

## Последовательность выполнения

1. Начать с базовых моделей (Services, Fabrics)
2. Постепенно заменять мок-данные на реальные, тестируя каждый шаг
3. Обновлять соответствующие компоненты UI
4. Двигаться от простых моделей к более сложным со связями

## Ожидаемые результаты

- Полностью работающее приложение с реальными данными из базы данных
- Оптимизированные запросы для хорошей производительности
- Корректная работа всех CRUD-операций через server actions
- Правильно настроенная валидация входящих данных
- Работающее кэширование и ревалидация данных

## Пошаговое внедрение в проект

### Шаг 1: Настройка базы данных и выполнение миграции

1. Установить PostgreSQL и создать базу данных dresscutur
2. Проверить и при необходимости обновить строку подключения в .env
3. Установить недостающие зависимости:
   ```
   npm install ts-node --save-dev
   ```
4. Выполнить первичную миграцию:
   ```
   npx prisma migrate dev --name init
   ```
5. Заполнить базу тестовыми данными:
   ```
   npx prisma db seed
   ```
6. Проверить, что данные добавились через Prisma Studio:
   ```
   npx prisma studio
   ```

### Шаг 2: Внедрение server actions для работы с данными

1. Создать новые файлы server actions с использованием Prisma:
   - app/actions/admin/services-prisma.ts
   - app/actions/admin/fabrics-prisma.ts
   - app/actions/admin/gallery-prisma.ts
   - app/actions/admin/faq-prisma.ts
   - app/actions/public/contact-actions.ts

2. Поочередно заменить импорты в компонентах и страницах:
   ```typescript
   // Старый импорт
   import { getServices } from '~/app/actions/admin/services';
   
   // Новый импорт
   import { getServices } from '~/app/actions/admin/services-prisma';
   ```

3. После тестирования полностью заменить файлы server actions:
   ```
   mv app/actions/admin/services-prisma.ts app/actions/admin/services.ts
   mv app/actions/admin/fabrics-prisma.ts app/actions/admin/fabrics.ts
   mv app/actions/admin/gallery-prisma.ts app/actions/admin/gallery.ts
   mv app/actions/admin/faq-prisma.ts app/actions/admin/faq.ts
   ```

### Шаг 3: Обновление компонентов на фронтенде

1. Обновить компоненты для работы с реальными данными из БД
2. Добавить обработку ошибок и состояний загрузки
3. Применить оптимистичные обновления UI для лучшего UX

### Шаг 4: Оптимизация и тестирование

1. Тщательно протестировать каждый CRUD-сценарий
2. Оптимизировать запросы для улучшения производительности
3. Настроить кэширование для часто используемых данных

### Шаг 5: Настройка загрузки файлов

1. Настроить UploadThing для загрузки изображений
2. Интегрировать загрузку файлов в формы и компоненты
3. Обеспечить безопасное хранение и доступ к медиа-файлам
